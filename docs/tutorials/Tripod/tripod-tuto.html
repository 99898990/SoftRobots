<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="../../../docs/style.css" type="text/css" />
</head>
<body>
<div class="figure">
<img src="../../images/pluginimage.png" style="width:100.0%" />

</div>
<script language="javascript">
function toggle(target) {
    d = document.getElementById(target);
    if(d.className === "show")
        d.className = "hide"
    else 
        d.className = "show"
    return false;
}
</script>
<h2 id="simulating-a-soft-robot">Simulating a soft robot</h2>
<p>This tutorial describes how to set-up a simulation environment, a scene, using <a href="https://www.sofa-framework.org/">Sofa</a> and how to use the <a href="https://project.inria.fr/softrobot/">SoftRobots</a> plugin to model a virtual soft robot driven by servo motors. Once modeled in Sofa the robot can be simulated and controlled.</p>
<p>Tutorials prequisites:</p>
<ul>
<li><p>installed <a href="https://www.sofa-framework.org/">Sofa</a> with the <a href="http://stlib.readthedocs.io/en/latest/">STLIB</a> and <a href="https://project.inria.fr/softrobot/">SoftRobots</a> plugins.</p></li>
<li><p>you have basic knowledge of the <a href="https://www.python.org/">Python</a> programming language. If this is not the case you can go to <a href="https://www.python.org/">Python</a>Tutorials.</p></li>
<li><p>you have basic knowledge of making scenes with Sofa. If not, please complete the <a href="../FirstSteps/firststeps-tuto.html">FirstStep</a> tutorial first.</p></li>
</ul>
<p>The robot we are going to simulate and controlled is acutated by three servo motors connected to a deformable material.</p>
<div class="figure">
<img src="images/tripodPhoto.jpg" style="width:25.0%" />

</div>
<h3 id="step-1-making-a-simple-scene-with-sofa">Step 1: Making a simple scene with Sofa</h3>
<pre>
<a href="details/step1.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step1code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step1code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In this step we are teaching the basic concept of Sofa that are:</span>
<span class="co">    Concepts: SceneGraph, Node, Components, Data and data links, </span>
<span class="co">    GUI: Scenegraph view, 3d view, animate button, double click on to get the data,  </span>
<span class="co">&quot;&quot;&quot;</span>       
<span class="kw">def</span> createScene(rootNode):
    visual <span class="op">=</span> rootNode.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>)    
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])</code></pre></div>
</div>
</div>
<h4 id="at-this-step-you-should-be-able-to"><i>At this step you should be able to:</i></h4>
<ul>
<li><p>Load a scene in sofa with the -i option and open the scene in your text editor.</p></li>
<li><p>Understand that the '-i' allows there to automatically reload the file when there is changes.</p></li>
<li><p>Add a visual object in the scene</p></li>
<li><p>Move the object in the scene</p></li>
<li><p>Be able to visualize in the GUI the different properties of sofa objects</p></li>
<li><p>Know how to change object properties (data)</p></li>
<li><p>Know how to connect the properties from two different object with a link.</p></li>
</ul>
<h3 id="step-2-adding-mechanical-objects">Step 2: Adding mechanical objects</h3>
<pre>
<a href="details/step2.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step2code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step2code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step2 we are teaching the basic concepts of Sofa that are:</span>
<span class="co">    Components: MechanicaObject, UniformMass, (rester vague: EulerImplicit, CGLinearSolver)</span>
<span class="co">&quot;&quot;&quot;</span>       
<span class="co">#from tuto import Scene</span>

<span class="kw">def</span> createScene(rootNode):
    rootNode.findData(<span class="st">&#39;dt&#39;</span>).value <span class="op">=</span> <span class="fl">0.001</span>
    visual <span class="op">=</span> rootNode.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>)    
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])
    

    elasticbody <span class="op">=</span> rootNode.createChild(<span class="st">&quot;ElasticBody&quot;</span>) 
    elasticbody.createObject(<span class="st">&quot;EulerImplicit&quot;</span>)
    elasticbody.createObject(<span class="st">&quot;SparseLDLSolver&quot;</span>)
    elasticbody.createObject(<span class="st">&quot;MechanicalObject&quot;</span>, name<span class="op">=</span><span class="st">&quot;dofs&quot;</span>,
                             position<span class="op">=</span>visual.loader.position, 
                             showObject<span class="op">=</span><span class="va">True</span>, showObjectScale<span class="op">=</span><span class="fl">10.0</span>)
    elasticbody.createObject(<span class="st">&quot;UniformMass&quot;</span>)

    elasticbody.createObject(<span class="st">&quot;IdentityMapping&quot;</span>, <span class="bu">input</span><span class="op">=</span>elasticbody.dofs.getLinkPath(), output<span class="op">=</span>visual.renderer.getLinkPath())</code></pre></div>
</div>
</div>
<h4 id="at-this-step-you-should-be-able-to-1"><i>At this step you should be able to:</i></h4>
<ul>
<li><p>Add a MechanicalObject</p></li>
<li><p>Add an UniformMass to this MechanicalObject</p></li>
<li><p>Visualize different properties of a MechanicalObject</p></li>
</ul>
<h3 id="step-3-modelling-deformable-material">Step 3: Modelling deformable material</h3>
<pre>
<a href="details/step3.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step3code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step3code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step3 we are teaching the following concepts</span>
<span class="co">    Components: TetrahedronFEMForceField, Constraints</span>
<span class="co">&quot;&quot;&quot;</span>       
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene

<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode, gravity<span class="op">=</span>[<span class="fl">0.0</span>,<span class="op">-</span><span class="fl">9810.0</span>,<span class="fl">0.0</span>])
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showForceFields&quot;</span>
    
    elasticbody <span class="op">=</span> rootNode.createChild(<span class="st">&quot;ElasticBody&quot;</span>) 
    elasticbody.createObject(<span class="st">&quot;EulerImplicit&quot;</span>)
    elasticbody.createObject(<span class="st">&quot;SparseLDLSolver&quot;</span>)
    elasticbody.createObject(<span class="st">&#39;GIDMeshLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/tripod_mid.gidmsh&quot;</span>)
    elasticbody.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
    elasticbody.createObject(<span class="st">&quot;MechanicalObject&quot;</span>, name<span class="op">=</span><span class="st">&quot;dofs&quot;</span>, showObject<span class="op">=</span><span class="va">True</span>, showObjectScale<span class="op">=</span><span class="fl">5.0</span>, rotation<span class="op">=</span>[<span class="fl">90.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>])
    elasticbody.createObject(<span class="st">&quot;UniformMass&quot;</span>, totalMass<span class="op">=</span><span class="fl">0.032</span>)
    elasticbody.createObject(<span class="st">&quot;TetrahedronFEMForceField&quot;</span>,youngModulus<span class="op">=</span><span class="dv">150</span>, poissonRatio<span class="op">=</span><span class="fl">0.45</span>)
    
    visual <span class="op">=</span> elasticbody.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>, translate<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">100.0</span>,<span class="fl">1.0</span>])    
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])
    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>)


    </code></pre></div>
</div>
</div>
<h4 id="at-this-step-you-should-be-able-to-2"><i>At this step you should be able to:</i></h4>
<ul>
<li><p>Understand what a ForceField is</p></li>
<li><p>Use the TetrahedronFEMForceField that provide elastic material behavior based on Finite Element Method</p></li>
<li><p>Understand how to make a reusable component with function or class.</p></li>
<li><p>Understand how to search in the automatically generated documentation.</p></li>
</ul>
<h3 id="step-4-adding-externals-constraints">Step 4: Adding externals constraints</h3>
<pre>
<a href="details/step4.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step4code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step4code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step3 we are teaching the following concepts</span>
<span class="co">    Components: TetrahedronFEMForceField, Constraints</span>
<span class="co">&quot;&quot;&quot;</span>       
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> fixingbox <span class="im">import</span> FixingBox

<span class="kw">def</span> ElasticBody(parent):
    body <span class="op">=</span> parent.createChild(<span class="st">&quot;ElasticBody&quot;</span>)

    e <span class="op">=</span> ElasticMaterialObject(body, volumeMeshFileName<span class="op">=</span><span class="st">&quot;data/mesh2/tripod_mid.gidmsh&quot;</span>,
                              poissonRatio<span class="op">=</span><span class="fl">0.45</span>, youngModulus<span class="op">=</span><span class="dv">150</span>, totalMass<span class="op">=</span><span class="fl">0.032</span>,
                              rotation<span class="op">=</span>[<span class="dv">90</span>,<span class="dv">0</span>,<span class="dv">0</span>])
    visual <span class="op">=</span> e.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>)    
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])

    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>, 
                             <span class="bu">input</span><span class="op">=</span>e.dofs.getLinkPath(), 
                             output<span class="op">=</span>visual.renderer.getLinkPath())

    <span class="cf">return</span> body 

<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode, gravity<span class="op">=</span>[<span class="fl">0.0</span>,<span class="op">-</span><span class="fl">9810.0</span>,<span class="fl">0.0</span>])
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showBehavior&quot;</span>

   
    body <span class="op">=</span> ElasticBody(rootNode)

    fix <span class="op">=</span> FixingBox(rootNode, body.ElasticMaterialObject, translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>], scale<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>])
    fix.boxroi.drawBoxes<span class="op">=</span><span class="va">True</span></code></pre></div>
</div>
</div>
<h4 id="at-this-step-you-should-be-able-to-3"><i>At this step you should be able to:</i></h4>
<ul>
<li><p>Understand what is a BoxROI</p></li>
<li><p>Understand how this Fixing Box ROI is implemented using a RestShapeSpringForceField</p></li>
<li><p>Change the location of the box to constraint a specific location</p></li>
</ul>
<h3 id="step-5-adding-actuators">Step 5: Adding actuators</h3>
<pre>
<a href="details/step5.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step5code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step5code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step3 we are teaching the following concepts</span>
<span class="co">    Components: TetrahedronFEMForceField, Constraints</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="im">from</span> splib.numerics <span class="im">import</span> sin,cos, to_radians, RigidDof
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> actuatedarm <span class="im">import</span> ActuatedArm

<span class="kw">def</span> ElasticBody(parent):
    body <span class="op">=</span> parent.createChild(<span class="st">&quot;ElasticBody&quot;</span>)

    e <span class="op">=</span> ElasticMaterialObject(body, volumeMeshFileName<span class="op">=</span><span class="st">&quot;data/mesh2/tripod_mid.gidmsh&quot;</span>, 
                              poissonRatio<span class="op">=</span><span class="fl">0.45</span>, youngModulus<span class="op">=</span><span class="dv">150</span>, totalMass<span class="op">=</span><span class="fl">0.032</span>,
                              translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">27.0</span>,<span class="fl">0.0</span>], rotation<span class="op">=</span>[<span class="dv">90</span>,<span class="dv">0</span>,<span class="dv">0</span>])
    visual <span class="op">=</span> body.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>, translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">27.0</span>,<span class="fl">0.0</span>])
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])

    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>,
                             <span class="bu">input</span><span class="op">=</span>e.dofs.getLinkPath(),
                             output<span class="op">=</span>visual.renderer.getLinkPath())
    <span class="cf">return</span> body


<span class="kw">def</span> Tripod(parent, name<span class="op">=</span><span class="st">&quot;Tripod&quot;</span>, radius<span class="op">=</span><span class="dv">55</span>, numMotors<span class="op">=</span><span class="dv">3</span>, angleShift<span class="op">=</span><span class="fl">180.0</span>):
    tripod <span class="op">=</span> parent.createChild(name)
    body <span class="op">=</span> ElasticBody(tripod)
    
    dist <span class="op">=</span> radius
    numstep <span class="op">=</span> numMotors
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(<span class="dv">0</span>,numstep):
        name <span class="op">=</span> <span class="st">&quot;ActuatedArm&quot;</span><span class="op">+</span><span class="bu">str</span>(i)
        fi <span class="op">=</span> <span class="bu">float</span>(i)
        fnumstep <span class="op">=</span> <span class="bu">float</span>(numstep)
        angle <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep
        angle2 <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep<span class="op">+</span>angleShift
        eulerRotation <span class="op">=</span> [<span class="dv">0</span>,angle,<span class="dv">0</span>]
        translation <span class="op">=</span> [dist<span class="op">*</span>sin(to_radians(angle2)), <span class="op">-</span><span class="fl">1.35</span>, dist<span class="op">*</span>cos(to_radians(angle2))]

        c <span class="op">=</span> ActuatedArm(tripod, name<span class="op">=</span>name,
                                       translation<span class="op">=</span>translation, eulerRotation<span class="op">=</span>eulerRotation,
                                       attachingTo<span class="op">=</span>body.ElasticMaterialObject)

    <span class="cf">return</span> tripod


<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode)
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showBehavior&quot;</span>

    Tripod(rootNode)</code></pre></div>
</div>
</div>
<h4 id="at-this-step-you-should-be-able-to-4"><i>At this step you should be able to:</i></h4>
<ul>
<li><p>Explore the actuatedarm.py &amp; s90servo.py which define the actuators.</p></li>
<li><p>Explore the Info panel of a component and observe that the prefab have self documentation &amp; specific properties</p></li>
<li><p>Understand the structure of the actuatedarm prefabricated object.</p></li>
<li><p>Understand how the ServoMotor &amp; ServoWheel are interoperating</p></li>
<li><p>Change the initial configuration of the actuatedarm so they constrain a different part of the model</p></li>
</ul>
<h3 id="step-6-adding-controllers">Step 6: Adding controllers</h3>
<p>Controllers allow to implement custom behavior and user interaction in python. In this step we are adding such a controller name MyController. This implemented behavior is that the ServoMotor angles when the user is pressing keys up, down, left, right, + and -. When the user is pressing the spacebar an animation is started that moves the robots from its a flat configuration to one that match the ones of the fabricated robot.</p>
<pre>
<a href="details/step6.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step6code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step6code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step3 we are teaching the following concepts</span>
<span class="co">    Components: TetrahedronFEMForceField, Constraints</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="im">import</span> Sofa
<span class="im">from</span> splib.numerics <span class="im">import</span> RigidDof
<span class="im">from</span> splib.animation <span class="im">import</span> animate
<span class="im">from</span> splib.constants <span class="im">import</span> Key
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> splib.numerics <span class="im">import</span> sin,cos, to_radians
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> actuatedarm <span class="im">import</span> ActuatedArm

<span class="kw">def</span> ElasticBody(parent):
    body <span class="op">=</span> parent.createChild(<span class="st">&quot;ElasticBody&quot;</span>)

    e <span class="op">=</span> ElasticMaterialObject(body, 
                              totalMass<span class="op">=</span><span class="fl">0.032</span>, poissonRatio<span class="op">=</span><span class="fl">0.45</span>, youngModulus<span class="op">=</span><span class="dv">150</span>, 
                              volumeMeshFileName<span class="op">=</span><span class="st">&quot;data/mesh2/tripod_mid.gidmsh&quot;</span>,rotation<span class="op">=</span>[<span class="dv">90</span>,<span class="dv">0</span>,<span class="dv">0</span>],  translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="dv">27</span>,<span class="fl">0.0</span>])
    visual <span class="op">=</span> body.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/branch.stl&quot;</span>, translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="dv">27</span>,<span class="fl">0.0</span>])
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])

    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>,
                             <span class="bu">input</span><span class="op">=</span>e.dofs.getLinkPath(),
                             output<span class="op">=</span>visual.renderer.getLinkPath())

    e.addCollisionModel(collisionMesh<span class="op">=</span><span class="st">&quot;data/mesh/tripod.stl&quot;</span>)

    <span class="cf">return</span> body


<span class="kw">def</span> Tripod(parent, name<span class="op">=</span><span class="st">&quot;Tripod&quot;</span>, radius<span class="op">=</span><span class="dv">55</span>, numMotors<span class="op">=</span><span class="dv">3</span>, angleShift<span class="op">=</span><span class="fl">180.0</span>):
    tripod <span class="op">=</span> parent.createChild(name)
    body <span class="op">=</span> ElasticBody(tripod)
    
    dist <span class="op">=</span> radius
    numstep <span class="op">=</span> numMotors
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(<span class="dv">0</span>,numstep):
        name <span class="op">=</span> <span class="st">&quot;ActuatedArm&quot;</span><span class="op">+</span><span class="bu">str</span>(i)
        fi <span class="op">=</span> <span class="bu">float</span>(i)
        fnumstep <span class="op">=</span> <span class="bu">float</span>(numstep)
        angle <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep
        angle2 <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep<span class="op">+</span>angleShift
        eulerRotation <span class="op">=</span> [<span class="dv">0</span>,angle,<span class="dv">0</span>]
        translation <span class="op">=</span> [dist<span class="op">*</span>sin(to_radians(angle2)), <span class="op">-</span><span class="fl">1.35</span>, dist<span class="op">*</span>cos(to_radians(angle2))]

        c <span class="op">=</span> ActuatedArm(tripod, name<span class="op">=</span>name,
                                       translation<span class="op">=</span>translation, eulerRotation<span class="op">=</span>eulerRotation,
                                       attachingTo<span class="op">=</span>body.ElasticMaterialObject)

    <span class="cf">return</span> tripod

<span class="kw">def</span> setupanimation(actuators, step, angularstep, factor):
    <span class="cf">for</span> actuator <span class="op">in</span> actuators:
            rigid <span class="op">=</span> RigidDof( actuator.dofs )
            rigid.translate( rigid.forward <span class="op">*</span> step <span class="op">*</span> factor )
            actuator.ServoMotor.angle <span class="op">+=</span> angularstep <span class="op">*</span> factor

<span class="kw">class</span> MyController(Sofa.PythonScriptController):
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node, actuators):
        <span class="va">self</span>.stepsize <span class="op">=</span> <span class="fl">0.1</span>
        <span class="va">self</span>.actuators <span class="op">=</span> actuators

    <span class="kw">def</span> onKeyPressed(<span class="va">self</span>, key):
        <span class="cf">if</span> key <span class="op">==</span> Key.uparrow:
            <span class="va">self</span>.actuators[<span class="dv">0</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize 
        <span class="cf">elif</span> key <span class="op">==</span> Key.downarrow:            
            <span class="va">self</span>.actuators[<span class="dv">0</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize

        <span class="cf">if</span> key <span class="op">==</span> Key.leftarrow:
            <span class="va">self</span>.actuators[<span class="dv">1</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize 
        <span class="cf">elif</span> key <span class="op">==</span> Key.rightarrow:            
            <span class="va">self</span>.actuators[<span class="dv">1</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize

        <span class="cf">if</span> key <span class="op">==</span> Key.plus:
            <span class="va">self</span>.actuators[<span class="dv">2</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize 
        <span class="cf">elif</span> key <span class="op">==</span> Key.minus:            
            <span class="va">self</span>.actuators[<span class="dv">2</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize

        <span class="cf">if</span> key <span class="op">==</span> Key.space:
            animate(setupanimation,{<span class="st">&quot;actuators&quot;</span> : <span class="va">self</span>.actuators, <span class="st">&quot;step&quot;</span> : <span class="fl">3.0</span>, 
                                    <span class="co">&quot;angularstep&quot;</span> : <span class="op">-</span><span class="fl">0.14</span>}, duration<span class="op">=</span><span class="fl">0.2</span>)    

<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode, gravity<span class="op">=</span>[<span class="fl">0.0</span>,<span class="op">-</span><span class="dv">9810</span>,<span class="fl">0.0</span>])
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showBehavior&quot;</span>

    model <span class="op">=</span> scene.createChild(<span class="st">&quot;Model&quot;</span>)
    
    tripod <span class="op">=</span> Tripod(model)

    MyController(rootNode, [tripod.ActuatedArm0, 
                            tripod.ActuatedArm1, 
                            tripod.ActuatedArm2])

    simu <span class="op">=</span> scene.createChild(<span class="st">&quot;SimulationPlan&quot;</span>)
    simu.createObject(<span class="st">&quot;EulerImplicit&quot;</span>)    
    simu.createObject(<span class="st">&quot;CGLinearSolver&quot;</span>)
    simu.addChild(tripod.ActuatedArm0)
    simu.addChild(tripod.ActuatedArm1)
    simu.addChild(tripod.ActuatedArm2)</code></pre></div>
</div>
</div>
<h3 id="step-7-connecting-to-the-physical-world.">Step 7: Connecting to the physical world.</h3>
<pre>
<a href="details/step7.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step7code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step6code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="im">import</span> Sofa
<span class="im">from</span> splib.debug <span class="im">import</span> DebugManager, drawText 
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene, ContactHeader
<span class="im">from</span> splib.numerics <span class="im">import</span> sin,cos, to_radians, RigidDof
<span class="im">from</span> splib.animation <span class="im">import</span> animate
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> splib.constants <span class="im">import</span> Key
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> stlib.physics.rigid <span class="im">import</span> Sphere
<span class="im">from</span> actuatedarm <span class="im">import</span> ActuatedArm
<span class="im">from</span> math <span class="im">import</span> floor


<span class="kw">def</span> ElasticBody(parent):
    body <span class="op">=</span> parent.createChild(<span class="st">&quot;ElasticBody&quot;</span>)

    e <span class="op">=</span> ElasticMaterialObject(body,
                              volumeMeshFileName<span class="op">=</span><span class="st">&quot;data/mesh2/tripod_mid.gidmsh&quot;</span>,
                              translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="dv">30</span>,<span class="fl">0.0</span>], rotation<span class="op">=</span>[<span class="dv">90</span>,<span class="dv">0</span>,<span class="dv">0</span>], youngModulus<span class="op">=</span><span class="dv">500</span>, totalMass<span class="op">=</span><span class="fl">0.32</span>)
    visual <span class="op">=</span> body.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh2/tripod2.stl&quot;</span>)
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])

    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>,
                             <span class="bu">input</span><span class="op">=</span>e.dofs.getLinkPath(),
                             output<span class="op">=</span>visual.renderer.getLinkPath())

    e.addCollisionModel(collisionMesh<span class="op">=</span><span class="st">&quot;data/mesh/tripod.stl&quot;</span>)

    <span class="cf">return</span> body

<span class="kw">def</span> Tripod(parent, name<span class="op">=</span><span class="st">&quot;Tripod&quot;</span>, radius<span class="op">=</span><span class="dv">55</span>, numMotors<span class="op">=</span><span class="dv">3</span>, angleShift<span class="op">=</span><span class="fl">180.0</span>):
    tripod <span class="op">=</span> parent.createChild(name)
    body <span class="op">=</span> ElasticBody(tripod)

    dist <span class="op">=</span> radius
    numstep <span class="op">=</span> numMotors
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(<span class="dv">0</span>,numstep):
        name <span class="op">=</span> <span class="st">&quot;ActuatedArm&quot;</span><span class="op">+</span><span class="bu">str</span>(i)
        fi <span class="op">=</span> <span class="bu">float</span>(i)
        fnumstep <span class="op">=</span> <span class="bu">float</span>(numstep)
        angle <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep
        angle2 <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep<span class="op">+</span>angleShift
        eulerRotation <span class="op">=</span> [<span class="dv">0</span>,angle,<span class="dv">0</span>]
        translation <span class="op">=</span> [dist<span class="op">*</span>sin(to_radians(angle2)), <span class="op">-</span><span class="fl">1.35</span>, dist<span class="op">*</span>cos(to_radians(angle2))]

        c <span class="op">=</span> ActuatedArm(tripod, name<span class="op">=</span>name,
                                       translation<span class="op">=</span>translation, eulerRotation<span class="op">=</span>eulerRotation,
                                       attachingTo<span class="op">=</span>body.ElasticMaterialObject)
    <span class="cf">return</span> tripod

<span class="kw">def</span> setupanimation(actuators, step, angularstep, factor):
    <span class="cf">for</span> actuator <span class="op">in</span> actuators:
            rigid <span class="op">=</span> RigidDof( actuator.dofs )
            rigid.translate( rigid.forward <span class="op">*</span> step <span class="op">*</span> factor )
            actuator.ServoMotor.angle <span class="op">+=</span> angularstep <span class="op">*</span> factor

<span class="kw">class</span> MyController(Sofa.PythonScriptController):
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node, actuators, serialportctrl):
        <span class="va">self</span>.stepsize <span class="op">=</span> <span class="fl">0.1</span>
        <span class="va">self</span>.actuators <span class="op">=</span> actuators
        <span class="va">self</span>.serialportctrl <span class="op">=</span> serialportctrl

    <span class="kw">def</span> onKeyPressed(<span class="va">self</span>, key):
        <span class="cf">if</span> key <span class="op">==</span> Key.uparrow:
            <span class="va">self</span>.actuators[<span class="dv">0</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize
        <span class="cf">elif</span> key <span class="op">==</span> Key.downarrow:
            <span class="va">self</span>.actuators[<span class="dv">0</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize

        <span class="cf">if</span> key <span class="op">==</span> Key.leftarrow:
            <span class="va">self</span>.actuators[<span class="dv">1</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize
        <span class="cf">elif</span> key <span class="op">==</span> Key.rightarrow:
            <span class="va">self</span>.actuators[<span class="dv">1</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize

        <span class="cf">if</span> key <span class="op">==</span> Key.plus:
            <span class="va">self</span>.actuators[<span class="dv">2</span>].ServoMotor.angle <span class="op">+=</span> <span class="va">self</span>.stepsize
        <span class="cf">elif</span> key <span class="op">==</span> Key.minus:
            <span class="va">self</span>.actuators[<span class="dv">2</span>].ServoMotor.angle <span class="op">-=</span> <span class="va">self</span>.stepsize


        <span class="cf">if</span> key <span class="op">==</span> Key.A <span class="op">and</span> <span class="va">self</span>.serialportctrl.state <span class="op">==</span> <span class="st">&quot;init&quot;</span>:
            <span class="va">self</span>.serialportctrl.state <span class="op">=</span> <span class="st">&quot;no-comm&quot;</span>
            animate(setupanimation,{<span class="st">&quot;actuators&quot;</span> : <span class="va">self</span>.actuators, <span class="st">&quot;step&quot;</span> : <span class="fl">3.0</span>,
                                    <span class="co">&quot;angularstep&quot;</span> : <span class="op">-</span><span class="fl">0.145</span>}, duration<span class="op">=</span><span class="fl">0.2</span>)
        <span class="cf">if</span> key <span class="op">==</span> Key.B <span class="op">and</span> <span class="va">self</span>.serialportctrl.state <span class="op">==</span> <span class="st">&quot;no-comm&quot;</span>:
            <span class="va">self</span>.serialportctrl.state <span class="op">=</span> <span class="st">&quot;comm&quot;</span>

<span class="kw">def</span> SerialPortBridgeGeneric(rootNode, serialport<span class="op">=</span><span class="st">&quot;/dev/ttyUSB0&quot;</span>):
    <span class="cf">return</span> rootNode.createObject(<span class="st">&quot;SerialPortBridgeGeneric&quot;</span>, port<span class="op">=</span>serialport, baudRate<span class="op">=</span><span class="dv">115200</span>, size<span class="op">=</span><span class="dv">3</span>, listening<span class="op">=</span><span class="va">True</span>)

<span class="kw">class</span> SerialPortController(Sofa.PythonScriptController):
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node, inputs, serialport):
        <span class="va">self</span>.name <span class="op">=</span> <span class="st">&quot;serialportcontroller&quot;</span>
        <span class="va">self</span>.servos <span class="op">=</span> inputs
        <span class="va">self</span>.serialport <span class="op">=</span> serialport
        <span class="va">self</span>.serialport.sentData <span class="op">=</span> [<span class="dv">150</span>,<span class="dv">150</span>,<span class="dv">150</span>]
        <span class="va">self</span>.state <span class="op">=</span> <span class="st">&quot;init&quot;</span>       

  
    <span class="kw">def</span> onEndAnimationStep(<span class="va">self</span>, dt):
        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">&quot;init&quot;</span>:
            drawText(<span class="st">&quot;Press A once to got to final configuration&quot;</span>, <span class="dv">100</span>,<span class="dv">50</span>)
            <span class="cf">return</span>

        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">&quot;no-comm&quot;</span>:
            drawText(<span class="st">&quot;Press B once to start sending data&quot;</span>, <span class="dv">100</span>,<span class="dv">50</span>)
            <span class="cf">return</span>

        angles <span class="op">=</span> []

        <span class="cf">for</span> servo <span class="op">in</span> <span class="va">self</span>.servos:
            angleByte <span class="op">=</span> <span class="dv">90</span><span class="op">+</span>floor((servo.angle<span class="fl">+3.14</span><span class="op">/</span><span class="fl">2.0</span>)<span class="op">*</span><span class="dv">255</span><span class="op">/</span><span class="fl">3.14</span>) 
            <span class="cf">if</span> angleByte <span class="op">&lt;</span> <span class="dv">60</span>:
                angleByte <span class="op">=</span> <span class="dv">60</span>
            <span class="cf">if</span> angleByte <span class="op">&gt;</span> <span class="dv">180</span>:
                angleByte <span class="op">=</span> <span class="dv">180</span>
 
            angles.append( angleByte )

        <span class="va">self</span>.serialport.sentData <span class="op">=</span> angles

<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode, gravity<span class="op">=</span>[<span class="fl">0.0</span>,<span class="op">-</span><span class="fl">9810.0</span>,<span class="fl">0.0</span>], plugins<span class="op">=</span>[<span class="st">&quot;SoftRobots&quot;</span>])
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showBehavior&quot;</span>
    DebugManager(rootNode)
    ContactHeader(rootNode, alarmDistance<span class="op">=</span><span class="fl">0.1</span>, contactDistance<span class="op">=</span><span class="fl">0.01</span>)

    model <span class="op">=</span> scene.createChild(<span class="st">&quot;Model&quot;</span>)
    Sphere(model, translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">2.0</span>,<span class="fl">0.0</span>])

    tripod <span class="op">=</span> Tripod(model)

    serial <span class="op">=</span> SerialPortBridgeGeneric(rootNode)
    serialportctrl <span class="op">=</span> SerialPortController(rootNode, [tripod.ActuatedArm0.ServoMotor,
                                                     tripod.ActuatedArm1.ServoMotor,
                                                     tripod.ActuatedArm2.ServoMotor], serial)

    MyController(rootNode, [tripod.ActuatedArm0,
                            tripod.ActuatedArm1,
                            tripod.ActuatedArm2], serialportctrl)

    simu <span class="op">=</span> scene.createChild(<span class="st">&quot;SimulationPlan&quot;</span>)
    simu.createObject(<span class="st">&quot;EulerImplicit&quot;</span>)
    simu.createObject(<span class="st">&quot;CGLinearSolver&quot;</span>)
    simu.addChild(tripod.ActuatedArm0)
    simu.addChild(tripod.ActuatedArm1)
    simu.addChild(tripod.ActuatedArm2)</code></pre></div>
</div>
</div>
<h3 id="step-8-adding-collision">Step 8: Adding collision</h3>
<p>In this step we are adding a rigid Sphere object falling on the robots. By default there is no collision so we need to specifically activate that by adding 'Contact' to the existing scene.</p>
<pre>
<a href="details/step8.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step8code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step8code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># -*- coding: utf-8 -*-</span>
<span class="co">&quot;&quot;&quot;</span>
<span class="co">    In step3 we are teaching the following concepts</span>
<span class="co">    Components: TetrahedronFEMForceField, Constraints</span>
<span class="co">&quot;&quot;&quot;</span>

<span class="im">from</span> stlib.scene <span class="im">import</span> Scene, ContactHeader
<span class="im">from</span> splib.numerics <span class="im">import</span> sin,cos, to_radians
<span class="im">from</span> stlib.scene <span class="im">import</span> Scene
<span class="im">from</span> stlib.physics.deformable <span class="im">import</span> ElasticMaterialObject
<span class="im">from</span> stlib.physics.rigid <span class="im">import</span> Sphere
<span class="im">from</span> actuatedarm <span class="im">import</span> ActuatedArm

<span class="kw">def</span> ElasticBody(parent):
    body <span class="op">=</span> parent.createChild(<span class="st">&quot;ElasticBody&quot;</span>)

    e <span class="op">=</span> ElasticMaterialObject(body, 
                              volumeMeshFileName<span class="op">=</span><span class="st">&quot;data/mesh/tripod.gidmsh&quot;</span>,rotation<span class="op">=</span>[<span class="dv">90</span>,<span class="dv">0</span>,<span class="dv">0</span>])
    visual <span class="op">=</span> body.createChild(<span class="st">&quot;Visual&quot;</span>)
    visual.createObject(<span class="st">&quot;MeshSTLLoader&quot;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/tripod.stl&quot;</span>)
    visual.createObject(<span class="st">&quot;OglModel&quot;</span>, name<span class="op">=</span><span class="st">&quot;renderer&quot;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>, color<span class="op">=</span>[<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.5</span>])

    visual.createObject(<span class="st">&quot;BarycentricMapping&quot;</span>,
                             <span class="bu">input</span><span class="op">=</span>e.dofs.getLinkPath(),
                             output<span class="op">=</span>visual.renderer.getLinkPath())

    e.addCollisionModel(collisionMesh<span class="op">=</span><span class="st">&quot;data/mesh/tripod.stl&quot;</span>)

    <span class="cf">return</span> body


<span class="kw">def</span> Tripod(parent, name<span class="op">=</span><span class="st">&quot;Tripod&quot;</span>, radius<span class="op">=</span><span class="fl">4.0</span>, numMotors<span class="op">=</span><span class="dv">3</span>, angleShift<span class="op">=</span><span class="fl">180.0</span>):
    tripod <span class="op">=</span> parent.createChild(name)
    body <span class="op">=</span> ElasticBody(tripod)
    
    dist <span class="op">=</span> radius
    numstep <span class="op">=</span> numMotors
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(<span class="dv">0</span>,numstep):
        name <span class="op">=</span> <span class="st">&quot;ActuatedArm&quot;</span><span class="op">+</span><span class="bu">str</span>(i)
        fi <span class="op">=</span> <span class="bu">float</span>(i)
        fnumstep <span class="op">=</span> <span class="bu">float</span>(numstep)
        angle <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep
        angle2 <span class="op">=</span> fi<span class="op">*</span><span class="dv">360</span><span class="op">/</span>fnumstep<span class="op">+</span>angleShift
        eulerRotation <span class="op">=</span> [<span class="dv">0</span>,angle,<span class="dv">0</span>]
        translation <span class="op">=</span> [dist<span class="op">*</span>sin(to_radians(angle2)), <span class="op">-</span><span class="fl">1.35</span>, dist<span class="op">*</span>cos(to_radians(angle2))]

        c <span class="op">=</span> ActuatedArm(tripod, name<span class="op">=</span>name,
                                       translation<span class="op">=</span>translation, eulerRotation<span class="op">=</span>eulerRotation,
                                       attachingTo<span class="op">=</span>body.ElasticMaterialObject)
    <span class="cf">return</span> tripod


<span class="kw">def</span> createScene(rootNode):
    scene <span class="op">=</span> Scene(rootNode)
    scene.VisualStyle.displayFlags<span class="op">=</span><span class="st">&quot;showBehavior&quot;</span>

    ContactHeader(rootNode, alarmDistance<span class="op">=</span><span class="fl">0.1</span>, contactDistance<span class="op">=</span><span class="fl">0.01</span>)
    
    model <span class="op">=</span> scene.createChild(<span class="st">&quot;Model&quot;</span>)
    Sphere(model, translation<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">2.0</span>,<span class="fl">0.0</span>])

    tripod <span class="op">=</span> Tripod(model)

    simu <span class="op">=</span> scene.createChild(<span class="st">&quot;SimulationPlan&quot;</span>)
    simu.createObject(<span class="st">&quot;EulerImplicit&quot;</span>)    
    simu.createObject(<span class="st">&quot;CGLinearSolver&quot;</span>)
    simu.addChild(tripod.ActuatedArm0)
    simu.addChild(tripod.ActuatedArm1)
    simu.addChild(tripod.ActuatedArm2)</code></pre></div>
</div>
</div>
<h3 id="step-9-inverse-control">Step 9: Inverse control</h3>
<p>In the previous steps we where controlling the robot by directly specifying the angle of the ServorMotor object. In this step we will use Sofa to inverse the model and adding an effector to the simulation so that it become possible to specify the effector position and let the simulation computes the angles to reach the effectors's position.</p>
<pre>
<a href="Rigidification/TripodRigidInverse.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Try the scene in Sofa.</a>
<a href="myproject/tripod.pyscn"> <img src="../../images/icons/play.png" width="16px"/>Write it yourself.</a>
<a href="javascript:void" onclick="toggle('step9code');"> <img src="../../images/icons/play.png" width="16px"/>Show/Hide the code.</a>
</pre>
<div id="step9code" class="hide">
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> Sofa
<span class="im">from</span> math <span class="im">import</span> sin,cos,pi

<span class="im">import</span> os
path <span class="op">=</span> os.path.dirname(os.path.abspath(<span class="va">__file__</span>))<span class="op">+</span><span class="st">&#39;/../mesh/&#39;</span>
<span class="im">from</span> rigidControl <span class="im">import</span> <span class="op">*</span>

<span class="kw">def</span> AddConstantAndtransformTableInString(Table, add):
    sizeT <span class="op">=</span>  <span class="bu">len</span>(Table)<span class="op">;</span>
    strOut<span class="op">=</span> <span class="st">&#39; &#39;</span><span class="op">;</span>
    <span class="cf">for</span> p <span class="op">in</span> <span class="bu">range</span>(sizeT):
        strOut <span class="op">=</span> strOut<span class="op">+</span> <span class="bu">str</span>(Table[p]<span class="op">+</span>add)<span class="op">+</span><span class="st">&#39; &#39;</span>

    <span class="cf">return</span> strOut

<span class="kw">def</span> transformTableInString(Table):
    sizeT <span class="op">=</span>  <span class="bu">len</span>(Table)<span class="op">;</span>
    strOut<span class="op">=</span> <span class="st">&#39; &#39;</span><span class="op">;</span>
    <span class="cf">for</span> p <span class="op">in</span> <span class="bu">range</span>(sizeT):
        strOut <span class="op">=</span> strOut<span class="op">+</span> <span class="bu">str</span>(Table[p])<span class="op">+</span><span class="st">&#39; &#39;</span>

    <span class="cf">return</span> strOut

<span class="co">#Takes a n dimensional vector of vector and transform it into a simple vector</span>
<span class="kw">def</span> transformDoubleTableInSimpleTable(Table):
    size0 <span class="op">=</span>  <span class="bu">len</span>(Table)<span class="op">;</span>

    <span class="co"># count the size</span>
    size<span class="op">=</span><span class="dv">0</span><span class="op">;</span>
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(size0):
        size <span class="op">=</span> size<span class="op">+</span><span class="bu">len</span>(Table[i])<span class="op">;</span>

    TableOut<span class="op">=</span>[<span class="dv">0</span>]<span class="op">*</span>size<span class="op">;</span>
    s<span class="op">=</span><span class="dv">0</span><span class="op">;</span>
    <span class="cf">for</span> i <span class="op">in</span> <span class="bu">range</span>(size0):
        <span class="cf">for</span> j <span class="op">in</span> <span class="bu">range</span>(<span class="bu">len</span>(Table[i])):
            TableOut[s] <span class="op">=</span> Table[i][j]<span class="op">;</span>
            s<span class="op">=</span>s<span class="dv">+1</span><span class="op">;</span>

    <span class="cf">return</span> TableOut



<span class="co">#Units: cm and kg</span>
<span class="kw">def</span> createScene(rootNode):
    rootNode.createObject(<span class="st">&#39;RequiredPlugin&#39;</span>, name<span class="op">=</span><span class="st">&#39;SoftRobots&#39;</span>, printLog<span class="op">=</span><span class="st">&quot;false&quot;</span>)
    rootNode.createObject(<span class="st">&#39;RequiredPlugin&#39;</span>, name<span class="op">=</span><span class="st">&#39;SofaPython&#39;</span>, printLog<span class="op">=</span><span class="st">&quot;false&quot;</span>)
    rootNode.createObject(<span class="st">&#39;VisualStyle&#39;</span>, displayFlags<span class="op">=</span><span class="st">&#39;showBehaviorModels showForceFields hideWireframe&#39;</span>)<span class="op">;</span>

    rootNode.findData(<span class="st">&#39;dt&#39;</span>).value<span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span>
    rootNode.findData(<span class="st">&#39;gravity&#39;</span>).value<span class="op">=</span> <span class="st">&#39;0. 0. 0&#39;</span><span class="op">;</span>

    rootNode.createObject(<span class="st">&#39;BackgroundSetting&#39;</span>, color<span class="op">=</span><span class="st">&#39;0 0.168627 0.211765&#39;</span>)<span class="op">;</span>
    rootNode.createObject(<span class="st">&#39;OglSceneFrame&#39;</span>, style<span class="op">=</span><span class="st">&quot;Arrows&quot;</span>, alignment<span class="op">=</span><span class="st">&quot;TopRight&quot;</span>)<span class="op">;</span>


    rootNode.createObject(<span class="st">&#39;FreeMotionAnimationLoop&#39;</span>)

    <span class="co"># Add a QPInverseProblemSolver to the scene if you need to solve inverse problem like the one that involved</span>
    <span class="co"># when manipulating the robots by specifying their effector&#39;s position instead of by direct control</span>
    <span class="co"># of the actuators parameters.</span>
    rootNode.createObject(<span class="st">&#39;QPInverseProblemSolver&#39;</span>, printLog<span class="op">=</span><span class="st">&#39;1&#39;</span>, epsilon<span class="op">=</span><span class="st">&#39;0.01&#39;</span>)


    <span class="co">##########################################</span>
    <span class="co"># EFFECTOR GOAL</span>
    <span class="co">##########################################</span>
    goal <span class="op">=</span> rootNode.createChild(<span class="st">&#39;goal&#39;</span>)
    goal.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, firstOrder<span class="op">=</span><span class="st">&#39;1&#39;</span>)
    goal.createObject(<span class="st">&#39;CGLinearSolver&#39;</span>, iterations<span class="op">=</span><span class="st">&#39;200&#39;</span>, threshold<span class="op">=</span><span class="st">&quot;1e-5&quot;</span>, tolerance<span class="op">=</span><span class="st">&quot;1e-5&quot;</span>)
    goal.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;goalMO&#39;</span>,
        showObject<span class="op">=</span><span class="st">&quot;1&quot;</span>,
        showObjectScale<span class="op">=</span><span class="st">&quot;3&quot;</span>,
        drawMode<span class="op">=</span><span class="st">&quot;1&quot;</span>,
        position <span class="op">=</span> <span class="st">&quot;0 0 32&quot;</span>)
    goal.createObject(<span class="st">&#39;UncoupledConstraintCorrection&#39;</span>)


    <span class="co">###############################</span>
    <span class="co">## MECHANICAL MODEL</span>
    <span class="co">###############################</span>
    robot <span class="op">=</span> rootNode.createChild(<span class="st">&#39;robot&#39;</span>)
    robot.createObject(<span class="st">&#39;EulerImplicit&#39;</span>)<span class="op">;</span>
    robot.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;ldl&#39;</span>, template<span class="op">=</span><span class="st">&#39;CompressedRowSparseMatrix3d&#39;</span>)<span class="op">;</span>
    robot.createObject(<span class="st">&#39;GenericConstraintCorrection&#39;</span>, solverName<span class="op">=</span><span class="st">&#39;ldl&#39;</span>)

    nodeFEM <span class="op">=</span> robot.createChild(<span class="st">&#39;nodeFEM&#39;</span>)

    loader<span class="op">=</span>nodeFEM.createObject(<span class="st">&#39;GIDMeshLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span>path<span class="op">+</span><span class="st">&#39;tripod1.msh&#39;</span>, scale<span class="op">=</span><span class="st">&#39;10&#39;</span>)<span class="op">;</span>
    loader.init()
    loader2<span class="op">=</span>nodeFEM.createObject(<span class="st">&#39;MeshVTKLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader2&#39;</span>, filename<span class="op">=</span>path<span class="op">+</span><span class="st">&#39;deformedMesh.vtu&#39;</span>)
    loader2.init()
    topo<span class="op">=</span>nodeFEM.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader2.position&#39;</span>, tetrahedra<span class="op">=</span><span class="st">&#39;@loader2.tetrahedra&#39;</span> , name<span class="op">=</span><span class="st">&#39;container&#39;</span>, createTriangleArray<span class="op">=</span><span class="st">&#39;1&#39;</span>, checkConnexity<span class="op">=</span><span class="st">&#39;1&#39;</span>)<span class="op">;</span>
    topo.init()

    <span class="co">### indices found with GID (begin at 1)</span>
    list_branch0<span class="op">=</span> [<span class="dv">509</span>, <span class="dv">534</span>,<span class="dv">556</span>,<span class="dv">573</span>,<span class="dv">592</span>,<span class="dv">603</span>,<span class="dv">504</span>,<span class="dv">532</span>,<span class="dv">555</span>,<span class="dv">571</span>,<span class="dv">591</span>, <span class="dv">601</span>]<span class="op">;</span>
    list_branch1<span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">16</span>,<span class="dv">25</span>,<span class="dv">28</span>,<span class="dv">43</span>,<span class="dv">47</span>,<span class="dv">63</span>,<span class="dv">67</span>]<span class="op">;</span>
    list_branch2<span class="op">=</span> [<span class="dv">629</span>,<span class="dv">627</span>,<span class="dv">623</span>,<span class="dv">620</span>,<span class="dv">612</span>,<span class="dv">602</span>,<span class="dv">630</span>,<span class="dv">628</span>,<span class="dv">624</span>, <span class="dv">621</span>,<span class="dv">614</span>,<span class="dv">604</span>]<span class="op">;</span>

    <span class="co">#same indices begin at 0</span>
    branch0<span class="op">=</span>[]
    <span class="cf">for</span> i <span class="op">in</span> list_branch0:
        branch0 <span class="op">=</span> branch0<span class="op">+</span>[i<span class="dv">-1</span>]

    branch1<span class="op">=</span>[]
    <span class="cf">for</span> i <span class="op">in</span> list_branch1:
        branch1 <span class="op">=</span> branch1<span class="op">+</span>[i<span class="dv">-1</span>]

    branch2<span class="op">=</span>[]
    <span class="cf">for</span> i <span class="op">in</span> list_branch2:
        branch2 <span class="op">=</span> branch2<span class="op">+</span>[i<span class="dv">-1</span>]

    center <span class="op">=</span> nodeFEM.createObject(<span class="st">&#39;SphereROI&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, centers<span class="op">=</span><span class="st">&#39;0 0 0&#39;</span>, radii<span class="op">=</span><span class="st">&#39;7&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, name<span class="op">=</span><span class="st">&#39;ROI&#39;</span>, computeTriangles<span class="op">=</span><span class="st">&#39;0&#39;</span>, computeEdges<span class="op">=</span><span class="st">&#39;0&#39;</span>)
    center.init()
    centerList <span class="op">=</span> transformDoubleTableInSimpleTable(center.indices)

    nodeFEM.createObject(<span class="st">&#39;TetrahedronSetTopologyModifier&#39;</span>)<span class="op">;</span>
    nodeFEM.createObject(<span class="st">&#39;TetrahedronSetTopologyAlgorithms&#39;</span>)<span class="op">;</span>
    nodeFEM.createObject(<span class="st">&#39;TetrahedronSetGeometryAlgorithms&#39;</span>)<span class="op">;</span>

    tetras<span class="op">=</span> nodeFEM.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;tetras&#39;</span>,  position<span class="op">=</span><span class="st">&#39;@container.position&#39;</span>, rest_position<span class="op">=</span><span class="st">&#39;@container.position&#39;</span>)<span class="op">;</span>
    mass <span class="op">=</span> nodeFEM.createObject(<span class="st">&#39;UniformMass&#39;</span>, totalmass<span class="op">=</span><span class="st">&#39;0.4&#39;</span>)<span class="op">;</span>
    tetraFF<span class="op">=</span> nodeFEM.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.45&#39;</span>,  youngModulus<span class="op">=</span><span class="st">&#39;20000&#39;</span>)<span class="op">;</span>

    y0<span class="op">=-</span><span class="dv">38</span>
    x0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>
    z0<span class="op">=</span><span class="dv">0</span>
    y1<span class="op">=</span>cos(<span class="dv">2</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">3</span>)<span class="op">*</span>y0<span class="op">;</span>
    x1<span class="op">=</span>sin(<span class="dv">2</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">3</span>)<span class="op">*</span>y0<span class="op">;</span>
    y2<span class="op">=</span>cos(<span class="dv">4</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">3</span>)<span class="op">*</span>y0<span class="op">;</span>
    x2<span class="op">=</span>sin(<span class="dv">4</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">3</span>)<span class="op">*</span>y0<span class="op">;</span>

    transform<span class="op">=</span> [ [x0,y0,z0,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>], [x1,y1,z0,<span class="dv">0</span>,<span class="dv">0</span>,sin(<span class="dv">4</span>.<span class="op">*</span>pi<span class="op">/</span><span class="dv">6</span>.),cos(<span class="dv">4</span>.<span class="op">*</span>pi<span class="op">/</span><span class="dv">6</span>.)],  [x2,y2,z0,<span class="dv">0</span>,<span class="dv">0</span>,sin(<span class="dv">2</span>.<span class="op">*</span>pi<span class="op">/</span><span class="dv">6</span>.),cos(<span class="dv">2</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">6</span>.)], [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>] ]


    <span class="co">###############################</span>
    <span class="co">## RIGID PART</span>
    <span class="co">###############################</span>
    controllerNode <span class="op">=</span> robot.createChild(<span class="st">&#39;controllerNode&#39;</span>)
    myController <span class="op">=</span> rigidControl(controllerNode, <span class="st">&quot;superCaMarche&quot;</span>, [branch0, branch1, branch2, centerList],[tetraFF, mass], tetras, nodeFEM, transform, <span class="dv">1</span>)

    visuServo <span class="op">=</span> rootNode.createChild(<span class="st">&#39;VisuServo&#39;</span>)
    visuServo.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span>path<span class="op">+</span><span class="st">&#39;SG90_servo_with_base.stl&#39;</span>, translation<span class="op">=</span><span class="st">&#39;-75 80 75&#39;</span>, rotation<span class="op">=</span><span class="st">&#39;90 0 -3&#39;</span>)
    visuServo.createObject(<span class="st">&#39;OglModel&#39;</span>, name<span class="op">=</span><span class="st">&#39;servo1&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, triangles<span class="op">=</span><span class="st">&#39;@loader.triangles&#39;</span>, scale<span class="op">=</span><span class="st">&quot;0.5&quot;</span>, translation<span class="op">=</span>[<span class="dv">0</span>,y0,<span class="dv">0</span>], color<span class="op">=</span><span class="st">&#39;white&#39;</span>)
    visuServo.createObject(<span class="st">&#39;OglModel&#39;</span>, name<span class="op">=</span><span class="st">&#39;servo2&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, triangles<span class="op">=</span><span class="st">&#39;@loader.triangles&#39;</span>, scale<span class="op">=</span><span class="st">&quot;0.5&quot;</span>, translation<span class="op">=</span>[<span class="op">-</span>x1,y1,<span class="dv">0</span>.], rotation<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">120</span>], color<span class="op">=</span><span class="st">&#39;white&#39;</span>)
    visuServo.createObject(<span class="st">&#39;OglModel&#39;</span>, name<span class="op">=</span><span class="st">&#39;servo3&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, triangles<span class="op">=</span><span class="st">&#39;@loader.triangles&#39;</span>, scale<span class="op">=</span><span class="st">&quot;0.5&quot;</span>, translation<span class="op">=</span>[<span class="op">-</span>x2,y2,<span class="dv">0</span>.], rotation<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">240</span>], color<span class="op">=</span><span class="st">&#39;white&#39;</span>)


    <span class="cf">return</span> rootNode</code></pre></div>
</div>
</div>
<h3 id="conclusion">Conclusion</h3>
<p>Congratulation, you completed this tutorial. You are strongly encouraged to pursue with the other tutorial and read the thematical documentations.</p>
<p>If you have any comments or suggestions, please submit issues on our <a href="https://github.com/SofaDefrost">github/SoftRobots</a> page.</p>
</body>
</html>
